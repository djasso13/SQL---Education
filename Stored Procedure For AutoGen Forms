------------
/*INSERTS STUDENT INTO FORM TABLE WITH E.STARDATE OF TODAY AND LANGUAGE OF SPA*/
BEGIN

INSERT INTO Form
			(documentID, personID, districtID, createdDate, modifiedByID, createdByID,
			 comments, module, personName, formDocName, endYear, requireGuardianES, guardianFill, 
			 modifiedDate, startTimestamp, endDate)

SELECT CASE
		WHEN E.grade IN ('KK','01','02','03','04') THEN 691
		WHEN E.grade = ('05') THEN 692 
		WHEN E.grade IN ('06','07','08') THEN 693 
		WHEN E.grade IN ('09','10','11','12') THEN 694
		END AS documentID, E.personID, E.districtID, GETDATE() as createdDate, 1 as modifiedByID, 1 as createdByID, 
		'effAutoFormGen' as comments,'eSignatures' as module, (I.lastName+', '+I.firstName+' '+ISNULL(LEFT(I.MIDDLENAME, 1),'')) AS personName, 
		CASE
		WHEN E.grade IN ('KK','01','02','03','04') THEN '2024-2025 Be Smart K-4 Grade SPA'
		WHEN E.grade = ('05') THEN '2024-2025 Be Smart 5th Grade SPA'
		WHEN E.grade IN ('06','07','08') THEN '2024-2025 Be Smart 6-8 Grade SPA'
		WHEN E.grade IN ('09','10','11','12') THEN '2024-2025 Be Smart 9-12 Grade SPA'
		END AS formDocName, 
		E.endYear, 'ONE' as requireGuardianES,1 as guardianFill, 
		GETDATE() AS modifiedDate, GETDATE() as startTimestamp, '2025-05-24' as endDate

FROM Enrollment E
JOIN Calendar CAL ON CAL.calendarID = E.calendarID AND CAL.endyear = (SELECT endyear FROM SchoolYear WHERE active = 1)
LEFT JOIN Contact ON Contact.personID = E.personID
JOIN Person P ON P.personID = E.personID
JOIN [Identity] I ON I.personID = P.personID AND I.identityID = P.currentIdentityID

WHERE 1 = 1
AND E.endDate IS NULL
AND E.grade NOT IN ('PK','PSI')
AND E.serviceType = 'P'
AND CAL.schoolID NOT IN (27,28,35,37,1,55,56,45)
AND (Contact.communicationLanguage = 'es_MX')
AND E.personID NOT IN 
(SELECT personID 
FROM Form 
WHERE documentID IN (691,692,693,694) 
AND endYear = (SELECT endYear FROM SchoolYear WHERE active = 1))
AND (E.personID NOT IN (SELECT personID FROM Form WHERE documentID in (636,637,638,639,640,641,642,643,644,645,646,647) 
						AND endYear = (SELECT endYear FROM SchoolYear WHERE active = 1)))/*leave this for students already with handbook for this year*/
END
------------



/*INSERTS INTO SPECIFIC FORM TABLE WITH NECESSARY INFO BEFORE BEING ASSIGNED TO PARENT*/


/*INSERTS INTO ENG K-4 BE SMART INFO TABLE*/
BEGIN

INSERT INTO Form.form_BSK42425SPA
(formID, personID,studentFirstNameStudentMiddleNameStudentLastName)
SELECT DISTINCT formID, Form.personID, (I.firstName+' '+ISNULL(I.middleName, '')+' '+I.lastName)
FROM Form
JOIN Enrollment E ON E.personID = Form.personID AND E.endYear = (SELECT endYear FROM SchoolYear WHERE active = 1)
JOIN Calendar CAL ON CAL.calendarID = E.calendarID
JOIN Person P ON P.personID = E.personID
JOIN [Identity] I ON I.personID = P.personID AND I.identityID = P.currentIdentityID
LEFT JOIN Contact ON Contact.personID = E.personID


WHERE 1 = 1
AND E.endDate IS NULL
AND E.serviceType = 'P'
AND Form.documentID = 691
AND Form.formID not in (SELECT formID FROM Form.form_BSK42425SPA)
AND (Contact.communicationLanguage = 'es_MX')
--AND CAST(STU.startDate AS DATE) = CAST(GETDATE() AS DATE)

END

/*INSERTS INTO ENG 5TH GRADE BE SMART INFO TABLE*/
BEGIN

INSERT INTO form.Form_BS5TH2425SPA
(formID, personID,studentFirstNameStudentMiddleNameStudentLastName)
SELECT DISTINCT formID, Form.personID, (I.firstName+' '+ISNULL(I.middleName, '')+' '+I.lastName)
FROM Form
JOIN Enrollment E ON E.personID = Form.personID AND E.endYear = (SELECT endYear FROM SchoolYear WHERE active = 1)
JOIN Calendar CAL ON CAL.calendarID = E.calendarID
JOIN Person P ON P.personID = E.personID
JOIN [Identity] I ON I.personID = P.personID AND I.identityID = P.currentIdentityID
LEFT JOIN Contact ON Contact.personID = E.personID


WHERE 1 = 1
AND E.endDate IS NULL
AND E.serviceType = 'P'
AND Form.documentID = 692
AND Form.formID not in (SELECT formID FROM form.Form_BS5TH2425SPA)
AND (Contact.communicationLanguage = 'es_MX')
--AND CAST(STU.startDate AS DATE) = CAST(GETDATE() AS DATE)

END

/*INSERTS INTO ENG 6-8 BE SMART INFO TABLE*/
BEGIN

INSERT INTO form.Form_BS682425SPA
(formID, personID,studentFirstNameStudentMiddleNameStudentLastName)
SELECT DISTINCT formID, Form.personID, (I.firstName+' '+ISNULL(I.middleName, '')+' '+I.lastName)
FROM Form
JOIN Enrollment E ON E.personID = Form.personID AND E.endYear = (SELECT endYear FROM SchoolYear WHERE active = 1)
JOIN Calendar CAL ON CAL.calendarID = E.calendarID
JOIN Person P ON P.personID = E.personID
JOIN [Identity] I ON I.personID = P.personID AND I.identityID = P.currentIdentityID
LEFT JOIN Contact ON Contact.personID = E.personID


WHERE 1 = 1
AND E.endDate IS NULL
AND E.serviceType = 'P'
AND Form.documentID = 693
AND Form.formID not in (SELECT formID FROM form.Form_BS682425SPA)
AND (Contact.communicationLanguage = 'es_MX')
--AND CAST(STU.startDate AS DATE) = CAST(GETDATE() AS DATE)
END

/*INSERTS INTO ENG 9-12 BE SMART INFO TABLE*/
BEGIN

INSERT INTO form.Form_BS9122425SPA
(formID, personID,studentFirstNameStudentMiddleNameStudentLastName)
SELECT DISTINCT formID, Form.personID, (I.firstName+' '+ISNULL(I.middleName, '')+' '+I.lastName)
FROM Form
JOIN Enrollment E ON E.personID = Form.personID AND E.endYear = (SELECT endYear FROM SchoolYear WHERE active = 1)
JOIN Calendar CAL ON CAL.calendarID = E.calendarID
JOIN Person P ON P.personID = E.personID
JOIN [Identity] I ON I.personID = P.personID AND I.identityID = P.currentIdentityID
LEFT JOIN Contact ON Contact.personID = E.personID


WHERE 1 = 1
AND E.endDate IS NULL
AND E.serviceType = 'P'
AND Form.documentID = 694
AND Form.formID not in (SELECT formID FROM form.Form_BS9122425SPA)
AND (Contact.communicationLanguage = 'es_MX')
--AND CAST(STU.startDate AS DATE) = CAST(GETDATE() AS DATE)

END

---------------------------------------------------



/*INSERTS INTO ESIGNATURE TABLE*/

/*K4 BE SMART ESIGNATURE INSERT*/
BEGIN

INSERT INTO ESignature
(personID, firstName, lastName, relationship, seq, status, createdByID, createdDate, notifyCreatorTime, comment, legacykey)
SELECT DISTINCT RP.personID2, I.firstName, I.lastName, RP.name, RP.seq, 'Pending', '1', GETDATE(), GETDATE()+7,'effAutoFormGenBSK4SPA2425', fm.formID

FROM RelatedPair RP
JOIN Form FM ON FM.personID = RP.personID1
JOIN Enrollment E ON E.personID = FM.personID
JOIN individual I ON I.personID = RP.personID2

WHERE 1 = 1
AND RP.guardian = 1
AND (RP.endDate IS NULL OR RP.endDate > GETDATE())
AND RP.seq IN (1,2)
AND FM.documentID = 691
AND CAST(FM.createdDate AS DATE) = CAST(GETDATE() AS DATE)
AND RP.personID2 NOT IN (SELECT personID FROM ESignature WHERE legacykey = FM.formID)

END

/*5TH BE SMART ESIGNATURE INSERT*/
BEGIN


INSERT INTO ESignature
(personID, firstName, lastName, relationship, seq, status, createdByID, createdDate, notifyCreatorTime, comment, legacykey)
SELECT DISTINCT RP.personID2, I.firstName, I.lastName, RP.name, RP.seq, 'Pending', '1', GETDATE(), GETDATE()+7,'effAutoFormGenBS5THSPA2425', fm.formID

FROM RelatedPair RP
JOIN Form FM ON FM.personID = RP.personID1
JOIN Enrollment E ON E.personID = FM.personID
JOIN individual I ON I.personID = RP.personID2

WHERE 1 = 1
AND RP.guardian = 1
AND (RP.endDate IS NULL OR RP.endDate > GETDATE())
AND RP.seq IN (1,2)
AND FM.documentID = 692
AND CAST(FM.createdDate AS DATE) = CAST(GETDATE() AS DATE)
AND RP.personID2 NOT IN (SELECT personID FROM ESignature WHERE legacykey = FM.formID)


END

/*6-8 BE SMART ESIGNATURE INSERT*/
BEGIN

INSERT INTO ESignature
(personID, firstName, lastName, relationship, seq, status, createdByID, createdDate, notifyCreatorTime, comment, legacykey)
SELECT DISTINCT RP.personID2, I.firstName, I.lastName, RP.name, RP.seq, 'Pending', '1', GETDATE(), GETDATE()+7,'effAutoFormGenBS68SPA2425', fm.formID

FROM RelatedPair RP
JOIN Form FM ON FM.personID = RP.personID1
JOIN Enrollment E ON E.personID = FM.personID
JOIN individual I ON I.personID = RP.personID2

WHERE 1 = 1
AND RP.guardian = 1
AND (RP.endDate IS NULL OR RP.endDate > GETDATE())
AND RP.seq IN (1,2)
AND FM.documentID = 693
AND CAST(FM.createdDate AS DATE) = CAST(GETDATE() AS DATE)
AND RP.personID2 NOT IN (SELECT personID FROM ESignature WHERE legacykey = FM.formID)


END

/*9-12 BE SMART ESIGNATURE INSERT*/
BEGIN

INSERT INTO ESignature
(personID, firstName, lastName, relationship, seq, status, createdByID, createdDate, notifyCreatorTime, comment, legacykey)
SELECT DISTINCT RP.personID2, I.firstName, I.lastName, RP.name, RP.seq, 'Pending', '1', GETDATE(), GETDATE()+7,'effAutoFormGenBS912SPA2425', fm.formID

FROM RelatedPair RP
JOIN Form FM ON FM.personID = RP.personID1
JOIN Enrollment E ON E.personID = FM.personID
JOIN individual I ON I.personID = RP.personID2

WHERE 1 = 1
AND RP.guardian = 1
AND (RP.endDate IS NULL OR RP.endDate > GETDATE())
AND RP.seq IN (1,2)
AND FM.documentID = 694
AND CAST(FM.createdDate AS DATE) = CAST(GETDATE() AS DATE)
AND RP.personID2 NOT IN (SELECT personID FROM ESignature WHERE legacykey = FM.formID)


END

-----------------------------------
BEGIN

WITH studentforms as 
(select fm.formID, fm.personID, rp.personID2, ROW_NUMBER() OVER (PARTITION BY rp.personID2 ORDER BY fm.createdDate ASC) AS form_rank
from Form fm
join RelatedPair rp on rp.personID1 = fm.personID
where 1=1
and rp.guardian = 1
and rp.endDate is null
AND FM.documentID IN (691,692,693,694)
and cast(fm.createdDate as date) = cast(getdate() as date)
)
, 
esigs as (
select esig.eSignatureID, esig.personID, ROW_NUMBER() OVER (PARTITION BY esig.personid ORDER BY esig.createdDate ASC) AS esig_rank, legacykey
from ESignature esig

where 1=1
and cast(createdDate as date) = cast(getdate() as date)

)
insert into FormESignature
(formID, eSignatureID)
select formID, esigs.eSignatureID

from studentforms sf
join esigs on esigs.personID = sf.personID2
and sf.formID = esigs.legacykey
AND SF.formID NOT IN (SELECT formID FROM FormESignature)

END
